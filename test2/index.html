<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WhatsApp Full Chat</title>
<style>
:root{--bg:#111b21;--panel:#202c33;--accent:#25d366;--muted:#97a4ab}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#e9edef;font-family:Arial,system-ui;min-height:100vh;display:flex;flex-direction:column}
#app{max-width:1100px;margin:0 auto;width:100%;height:100vh;display:flex;flex-direction:column;position:relative;transition:transform .28s ease}
#topBar{padding:8px 12px;background:#0b141a;display:flex;align-items:center;gap:12px;z-index:5}
#title{font-weight:600;display:flex;align-items:center;gap:10px}
#notifWrap{display:flex;align-items:center;gap:8px}
.bell{position:relative;cursor:pointer;width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,.04)}
.badge{position:absolute;top:-6px;right:-6px;min-width:20px;height:20px;border-radius:12px;background:#ff3b30;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;padding:0 6px;box-shadow:0 2px 6px rgba(0,0,0,.6)}

/* PANEL NAVIGATION */
#panel{position:fixed;right:0;top:0;height:100vh;width:360px;background:#081214;border-left:1px solid rgba(255,255,255,.03);transform:translateX(100%);transition:transform .28s ease;z-index:20;box-shadow:-20px 0 60px rgba(0,0,0,.6);display:flex;flex-direction:column}
#panel.open{transform:translateX(0)}
.panelHeader{padding:14px 12px;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:8px}
.panelTitle{font-weight:700}
.panelClose{margin-left:auto;background:none;border:0;color:var(--accent);cursor:pointer;font-size:18px}
.panelList{padding:8px;overflow:auto;flex:1}
.panelItem{padding:10px;border-radius:8px;display:flex;align-items:center;gap:10px;cursor:pointer}
.panelItem:hover{background:rgba(255,255,255,.02)}
.panelItem .who{flex:1}
.panelItem .count{background:#ff3b30;color:#fff;border-radius:12px;padding:2px 8px;font-size:12px}

#clearHistoryBtn{background:transparent;border:1px solid #ff3b30;color:#ff3b30;padding:4px 8px;border-radius:6px;font-size:11px;cursor:pointer;margin-right:10px}

/* MESSAGES */
#messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#071215}
.msg-row{display:flex;align-items:flex-end;max-width:80%;position:relative}
.msg-row.self{align-self:flex-end;flex-direction:row-reverse}
.avatar{width:36px;height:36px;border-radius:50%;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 8px;position:relative;cursor:pointer;border:2px solid transparent;overflow:hidden}
.avatar.online{border-color:var(--accent);box-shadow:0 0 0 0 rgba(37,211,102,.6);animation:pulse 1.5s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37,211,102,.6)}70%{box-shadow:0 0 0 6px rgba(37,211,102,0)}100%{box-shadow:0 0 0 0 rgba(37,211,102,0)}}
.bubble{background:var(--panel);padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.3;word-break:break-word}
.msg-row.self .bubble{background:#005c4b}
.meta{font-size:12px;color:#53bdeb;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right;display:flex;align-items:center;justify-content:flex-end;gap:4px}
.read-status{font-size:14px;line-height:1}
.read-status.read{color:#53bdeb}

#inputBar{display:flex;padding:10px;background:var(--panel);align-items:center;gap:8px}
#messageInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff;outline:none;font-size:14px}
#sendBtn{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
#statusLine{padding:6px 12px;font-size:13px;color:var(--muted);background:#071215}

/* SETTINGS PANEL */
#settingsWrap{position:relative}
#settingsBtn{cursor:pointer;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--muted)}
#settingsPanel{position:absolute;right:0;top:48px;background:#0b141a;border:1px solid rgba(255,255,255,.1);padding:12px;border-radius:12px;display:none;z-index:100;min-width:260px}
.settingRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.toggleBtn{width:46px;height:26px;border-radius:16px;background:#2a3942;position:relative;cursor:pointer}
.toggleKnob{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:left .18s}

/* PRIVATE POPUP */
#privatePopup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1000}
.card{background:#0b141a;padding:12px;border-radius:12px;max-width:680px;width:96%;display:flex;flex-direction:column;max-height:92%}
#privateMessages{flex:1;overflow:auto;padding:8px;background:#071215;border-radius:8px;display:flex;flex-direction:column;gap:8px}
.private-bubble{background:#162027;padding:8px 10px;border-radius:10px;max-width:80%}
.private-row.self{align-self:flex-end}

/* CALL OVERLAY DESIGN */
#callOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0b141a;z-index:10000;flex-direction:column;color:#fff;animation: fadeIn 0.3s ease;}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.callCard{background:radial-gradient(circle at center, #111b21 0%, #071215 100%); padding:60px 20px; display:flex; flex-direction:column; align-items:center; width:100%; height:100%; justify-content: space-between;}
.callAvatar{width:160px; height:160px; border-radius:50%; background:#2a3942; display:flex; align-items:center; justify-content:center; font-size:60px; overflow:hidden; border:4px solid var(--accent); box-shadow: 0 0 30px rgba(37,211,102,0.2);}
.callAvatar img{width:100%; height:100%; object-fit:cover}
.callName{font-size:28px; font-weight:700; margin-top:20px}
.callStatusText{font-size:18px; color:var(--accent); font-family: monospace;}
.callBtns{display:flex; gap:50px; margin-bottom:40px}
.circleBtn{width:75px; height:75px; border-radius:50%; border:0; display:flex; align-items:center; justify-content:center; font-size:32px; cursor:pointer; transition: transform 0.2s;}
.btnAccept{background:var(--accent); color:#fff; animation: shake 1.5s infinite;}
.btnDecline{background:#ff3b30; color:#fff}
.callControls{display:flex; gap:30px; margin-top:20px}
.ctrlBtn{width:55px; height:55px; border-radius:50%; background:rgba(255,255,255,0.1); border:none; color:#fff; cursor:pointer; font-size:20px}
.ctrlBtn.active{background:#fff; color:#000}

@keyframes shake {
  0%, 100% { transform: scale(1); }
  10%, 30%, 50% { transform: scale(1.1) rotate(5deg); }
  20%, 40%, 60% { transform: scale(1.1) rotate(-5deg); }
}

/* LOGIN */
#loginWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999}
#loginCard{background:#0b141a;padding:18px;border-radius:12px;display:flex;flex-direction:column;gap:10px;min-width:300px}
#loginCard input{padding:10px;border-radius:10px;border:0;background:#162027;color:#fff}
#loginCard button{padding:10px;border-radius:10px;border:0;background:var(--accent);color:#fff}

#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#2a3942;color:#fff;padding:10px 14px;border-radius:10px;z-index:10001;opacity:0;pointer-events:none;transition: 0.3s}
#toast.show{opacity:1;bottom:40px}
</style>
</head>
<body>

<div id="app">
  <div id="topBar">
    <div id="title">WhatsApp AI</div>
    <div style="flex:1"></div>
    <div id="notifWrap">
      <div class="bell" id="bellBtn">üîî<div class="badge" id="bellBadge" style="display:none">0</div></div>
      <div id="settingsWrap">
        <button id="settingsBtn">‚öôÔ∏è</button>
        <div id="settingsPanel">
            <div class="settingRow">
                <div>Audio Call</div>
                <div class="toggleBtn" id="toggleCall"><div class="toggleKnob" id="toggleCallKnob"></div></div>
            </div>
            <div class="settingRow">
                <div>Private Chat</div>
                <div class="toggleBtn" id="togglePrivate"><div class="toggleKnob" id="togglePrivateKnob"></div></div>
            </div>
            <input type="file" id="profileImgInput" accept="image/*" style="margin-top:10px; font-size:12px">
        </div>
      </div>
    </div>
  </div>
  <div id="statusLine"></div>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message"/>
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<div id="callOverlay">
  <div class="callCard">
    <div style="text-align:center">
        <div id="callTypeText" style="font-size:14px; color:var(--muted); margin-bottom:20px; text-transform:uppercase; letter-spacing:1px">Incoming Call</div>
        <div class="callAvatar" id="callAvatarContainer">?</div>
        <div class="callName" id="callFrom">User</div>
        <div id="callTimer" class="callStatusText" style="margin-top:10px">Ringing...</div>
    </div>

    <div id="activeCallControls" style="display:none; flex-direction: column; align-items: center; gap: 30px;">
        <div class="callControls">
            <button class="ctrlBtn" id="muteBtn">üé§</button>
            <button class="ctrlBtn" id="speakerBtn">üîä</button>
        </div>
        <button class="circleBtn btnDecline" id="endCallBtnBig">üìû</button>
    </div>

    <div class="callBtns" id="inboundCallBtns">
      <button class="circleBtn btnDecline" id="declineCallBtn">‚úï</button>
      <button class="circleBtn btnAccept" id="acceptCallBtn">‚úì</button>
    </div>
    
    <div class="callBtns" id="outboundCallBtns" style="display:none">
        <button class="circleBtn btnDecline" id="cancelCallBtn">‚úï</button>
    </div>
  </div>
</div>

<div id="privatePopup">
  <div class="card">
    <div style="display:flex; align-items:center; padding-bottom:10px">
        <button id="closePrivate" style="background:none;border:0;color:var(--accent);font-size:20px">‚¨Ö</button>
        <b id="privateTitle" style="margin-left:10px">Chat</b>
        <div style="flex:1"></div>
        <button id="callBtn" style="background:none;border:0;font-size:22px;cursor:pointer">üìû</button>
    </div>
    <div id="privateMessages"></div>
    <div style="display:flex; gap:10px; margin-top:10px">
        <input id="privateInput" style="flex:1; padding:10px; border-radius:20px; border:0; background:#2a3942; color:#fff" placeholder="Private message"/>
        <button id="privateSend" style="background:var(--accent); border:0; border-radius:50%; width:40px; color:#fff">‚û§</button>
    </div>
  </div>
</div>

<div id="loginWrap">
  <div id="loginCard">
    <b>Your Name</b>
    <input id="nameInput" placeholder="Enter name"/>
    <button id="joinBtn">Join Chat</button>
  </div>
</div>

<div id="toast"></div>

<audio id="ringtone" loop></audio>
<audio id="remoteAudio" autoplay></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// --- CONFIG & INITIALIZATION ---
const firebaseConfig = {
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- STATE ---
let username = localStorage.getItem('guestName') || '';
let profileImage = localStorage.getItem('profileImage') || '';
let privateChatWith = null;
let activeCall = null;
let callTimerInterval = null;
let peerConnection = null;
let localStream = null;

// --- RINGTONE BASE64 (Professional Digital Ring) ---
const digitalRingtone = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="; // Placeholder - logic below generates dynamic beep if empty
const ringAudio = document.getElementById('ringtone');
ringAudio.src = 'https://actions.google.com/sounds/v1/phone/phone_ring_loop.ogg'; // High quality fallback

// --- DOM ELEMENTS ---
const callOverlay = document.getElementById('callOverlay');
const callFrom = document.getElementById('callFrom');
const callAvatarContainer = document.getElementById('callAvatarContainer');
const callTimer = document.getElementById('callTimer');
const activeCallControls = document.getElementById('activeCallControls');
const inboundCallBtns = document.getElementById('inboundCallBtns');
const outboundCallBtns = document.getElementById('outboundCallBtns');

// --- APP START ---
if(!username) {
    document.getElementById('joinBtn').onclick = () => {
        const n = document.getElementById('nameInput').value.trim();
        if(n) { username = n; localStorage.setItem('guestName', n); location.reload(); }
    };
} else {
    document.getElementById('loginWrap').style.display = 'none';
    initApp();
}

function initApp() {
    db.ref(`status/${username}`).set(true);
    db.ref(`status/${username}`).onDisconnect().remove();
    db.ref(`profiles/${username}`).update({ name: username, profileImage, online: true });

    startGroupChat();
    watchCalls();
}

function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }

// --- CALLING LOGIC ---
async function watchCalls() {
    db.ref('calls').on('child_added', snap => {
        const c = snap.val();
        if(c.to === username && c.status === 'ringing') {
            activeCall = { id: snap.key, ...c };
            openCallUI(c.from, 'incoming');
            ringAudio.play().catch(()=>{});
        }
    });

    db.ref('calls').on('child_changed', snap => {
        const c = snap.val();
        if(c.status === 'answered' && (c.from === username || c.to === username)) {
            startActiveCallUI(c);
        }
        if(c.status === 'ended' || c.status === 'declined') {
            endCall();
        }
    });
}

async function openCallUI(otherName, type) {
    callFrom.textContent = otherName;
    callOverlay.style.display = 'flex';
    
    // Load Other User Profile
    db.ref(`profiles/${otherName}`).once('value', s => {
        const p = s.val();
        if(p && p.profileImage) callAvatarContainer.innerHTML = `<img src="${p.profileImage}">`;
        else callAvatarContainer.innerHTML = otherName[0].toUpperCase();
    });

    if(type === 'incoming') {
        document.getElementById('callTypeText').textContent = "Incoming Call";
        inboundCallBtns.style.display = 'flex';
        outboundCallBtns.style.display = 'none';
    } else {
        document.getElementById('callTypeText').textContent = "Calling...";
        inboundCallBtns.style.display = 'none';
        outboundCallBtns.style.display = 'flex';
    }
}

function startActiveCallUI(c) {
    ringAudio.pause();
    document.getElementById('callTypeText').textContent = "Ongoing Call";
    inboundCallBtns.style.display = 'none';
    outboundCallBtns.style.display = 'none';
    activeCallControls.style.display = 'flex';
    
    clearInterval(callTimerInterval);
    const start = c.answeredAt || Date.now();
    callTimerInterval = setInterval(() => {
        const diff = Date.now() - start;
        const m = Math.floor(diff/60000).toString().padStart(2,'0');
        const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
        callTimer.textContent = `${m}:${s}`;
    }, 1000);
}

document.getElementById('callBtn').onclick = () => {
    const id = "call_" + Date.now();
    activeCall = { id, from: username, to: privateChatWith };
    db.ref(`calls/${id}`).set({ 
        from: username, to: privateChatWith, status: 'ringing', startedAt: Date.now() 
    });
    openCallUI(privateChatWith, 'outgoing');
    ringAudio.play().catch(()=>{});
};

document.getElementById('acceptCallBtn').onclick = () => {
    db.ref(`calls/${activeCall.id}`).update({ status: 'answered', answeredAt: Date.now() });
};

document.getElementById('declineCallBtn').onclick = () => {
    db.ref(`calls/${activeCall.id}`).update({ status: 'declined' });
};

document.getElementById('endCallBtnBig').onclick = () => {
    db.ref(`calls/${activeCall.id}`).update({ status: 'ended' });
};

document.getElementById('cancelCallBtn').onclick = () => {
    db.ref(`calls/${activeCall.id}`).update({ status: 'ended' });
};

function endCall() {
    ringAudio.pause();
    ringAudio.currentTime = 0;
    callOverlay.style.display = 'none';
    activeCallControls.style.display = 'none';
    clearInterval(callTimerInterval);
    callTimer.textContent = "Ringing...";
    activeCall = null;
}

// --- GROUP CHAT CORE ---
function startGroupChat() {
    const msgRef = db.ref('messages').limitToLast(50);
    msgRef.on('child_added', snap => {
        const m = snap.val();
        const row = document.createElement('div');
        row.className = 'msg-row' + (m.name === username ? ' self' : '');
        row.innerHTML = `
            <div class="avatar" onclick="openPrivate('${m.name}')">${m.profileImage ? `<img src="${m.profileImage}" style="width:100%">` : m.name[0]}</div>
            <div class="bubble"><b>${m.name}</b><br>${m.text}</div>
        `;
        document.getElementById('messages').appendChild(row);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    });
}

document.getElementById('sendBtn').onclick = () => {
    const t = document.getElementById('messageInput').value;
    if(t) {
        db.ref('messages').push({ name: username, text: t, time: Date.now(), profileImage });
        document.getElementById('messageInput').value = '';
    }
};

// --- PRIVATE CHAT ---
function openPrivate(other) {
    if(other === username) return;
    privateChatWith = other;
    document.getElementById('privateTitle').textContent = other;
    document.getElementById('privatePopup').style.display = 'flex';
    // Logic for loading private messages would go here (similar to group chat)
}

document.getElementById('closePrivate').onclick = () => {
    document.getElementById('privatePopup').style.display = 'none';
};

// --- SETTINGS ---
document.getElementById('settingsBtn').onclick = (e) => {
    e.stopPropagation();
    const p = document.getElementById('settingsPanel');
    p.style.display = p.style.display === 'block' ? 'none' : 'block';
};

document.getElementById('profileImgInput').onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (ev) => {
        profileImage = ev.target.result;
        localStorage.setItem('profileImage', profileImage);
        db.ref(`profiles/${username}`).update({ profileImage });
        showToast("Profile image updated!");
    };
    reader.readAsDataURL(file);
};

// --- MUTE & SPEAKER UI TOGGLES ---
document.getElementById('muteBtn').onclick = function() {
    this.classList.toggle('active');
    showToast(this.classList.contains('active') ? "Muted" : "Unmuted");
};
document.getElementById('speakerBtn').onclick = function() {
    this.classList.toggle('active');
    showToast(this.classList.contains('active') ? "Speaker ON" : "Speaker OFF");
};

</script>
</body>
</html>
