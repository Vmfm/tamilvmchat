<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Dating App â€“ STABLE FINAL</title>

<!-- Firebase SDKs (COMPAT = WebView safe) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f0f;color:#fff}
.hidden{display:none}
header{background:#1b1b1b;padding:10px;display:flex;justify-content:space-between}
.card{max-width:420px;margin:20px auto;background:#1c1c1c;padding:15px;border-radius:14px}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none}
button{background:#ff2f6d;color:#fff;font-weight:bold}
.profile{display:flex;align-items:center;background:#222;padding:10px;border-radius:12px;margin:8px 0;cursor:pointer}
.profile img{width:60px;height:60px;border-radius:50%;margin-right:10px}
.online{width:10px;height:10px;background:lime;border-radius:50%;margin-left:auto}
#profiles{max-width:420px;margin:auto}
#chat{position:fixed;bottom:0;left:0;right:0;background:#111;padding:10px}
#messages{height:200px;overflow:auto;background:#000;padding:6px}
</style>
</head>
<body>

<header id="top" class="hidden">
  <span onclick="logout()">ðŸšª Logout</span>
</header>

<!-- LOGIN -->
<div class="card" id="login">
  <h2>Login</h2>
  <input id="name" placeholder="Name">
  <input id="age" type="number" placeholder="Age">
  <select id="gender"><option>Male</option><option>Female</option></select>
  <input type="file" id="photo" accept="image/*">
  <button onclick="loginUser()">Continue</button>
</div>

<!-- PROFILES -->
<div id="profiles" class="hidden"></div>

<!-- CHAT -->
<div id="chat" class="hidden">
  <h3 id="chatName"></h3>
  <div id="messages"></div>
  <input id="msg" placeholder="Message">
  <button onclick="sendMsg()">Send</button>
</div>

<script>
// Firebase init (NO ASYNC BUGS)
firebase.initializeApp({
  apiKey: "AIzaSyAlWP5D79PsX29H0hIZlfvL0YV5Us7v5I4",
  authDomain: "sample-firebase-ai-app-1f408.firebaseapp.com",
  databaseURL: "https://sample-firebase-ai-app-1f408-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sample-firebase-ai-app-1f408",
  storageBucket: "sample-firebase-ai-app-1f408.firebasestorage.app",
  messagingSenderId: "657942233322",
  appId: "1:657942233322:web:a8dd9896ca8cfccdbb5793"
});

const auth = firebase.auth();
const db = firebase.database();
const st = firebase.storage();
let me = null;
let peerId = null;

// VERY IMPORTANT: only UI logic inside here
auth.onAuthStateChanged(user => {
  if(user){
    me = user;
    loadProfiles();
  }
});

function loginUser(){
  if(!photo.files[0]){alert('Select image');return;}

  auth.signInAnonymously().then(res => {
    me = res.user;
    const ref = st.ref('profiles/' + me.uid);

    ref.put(photo.files[0])
      .then(() => ref.getDownloadURL())
      .then(url => {
        return db.ref('users/' + me.uid).set({
          name: name.value,
          age: age.value,
          gender: gender.value,
          img: url
        });
      })
      .then(() => loadProfiles());
  });
}

function loadProfiles(){
  login.classList.add('hidden');
  top.classList.remove('hidden');
  profiles.classList.remove('hidden');

  db.ref('users').off();
  db.ref('users').on('value', snap => {
    profiles.innerHTML = '';

    snap.forEach(c => {
      if(c.key !== me.uid){
        const u = c.val();
        if(!u) return;
        const d = document.createElement('div');
        d.className = 'profile';
        d.innerHTML = `<img src="${u.img}"><div>${u.name}, ${u.age} (${u.gender})</div><div class="online"></div>`;
        d.onclick = () => openChat(c.key, u.name);
        profiles.appendChild(d);
      }
    });

    if(!profiles.innerHTML){
      profiles.innerHTML = '<p style="text-align:center">No users online</p>';
    }
  });
}

function openChat(id, name){
  peerId = id;
  chatName.innerText = name;
  chat.classList.remove('hidden');
  loadChat();
}

function loadChat(){
  messages.innerHTML = '';
  db.ref('chat/' + me.uid + '/' + peerId).off();
  db.ref('chat/' + me.uid + '/' + peerId).on('child_added', s => {
    const d = document.createElement('div');
    d.innerText = s.val().t;
    messages.appendChild(d);
  });
}

function sendMsg(){
  if(!msg.value) return;
  const t = msg.value;
  db.ref('chat/' + me.uid + '/' + peerId).push({t});
  db.ref('chat/' + peerId + '/' + me.uid).push({t});
  msg.value = '';
}

function logout(){
  auth.signOut();
  location.reload();
}
</script>
</body>
</html>
