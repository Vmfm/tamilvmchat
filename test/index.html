<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tamil VM Chat</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<style>
body{margin:0;background:#0f0f0f;color:#fff;font-family:sans-serif}
.hidden{display:none}
.card{background:#1b1b1b;padding:15px;border-radius:12px}
.center{display:flex;justify-content:center;align-items:center;height:100vh}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none}
button{background:#00e676;font-weight:bold}
.top{display:flex;justify-content:space-between;padding:10px;background:#000}
.user{display:flex;align-items:center;padding:10px;border-bottom:1px solid #333}
.user img{width:50px;height:50px;border-radius:50%;margin-right:10px}
.dot{width:10px;height:10px;border-radius:50%;margin-left:auto}
.on{background:#00e676}
.off{background:#444}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:#000c;display:flex;justify-content:center;align-items:center}
.chat{height:50vh;overflow:auto;border:1px solid #333;padding:8px}
.msg{margin:4px}
.me{text-align:right;color:#00e676}
.badge{background:red;border-radius:50%;padding:2px 6px}
.timer{color:#0f0;text-align:center}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="card" style="width:300px">
    <h3>Login</h3>
    <input id="name" placeholder="Name">
    <input id="age" type="number" placeholder="Age">
    <select id="gender"><option>Male</option><option>Female</option></select>
    <input type="file" id="img">
    <button onclick="login()">Continue</button>
  </div>
</div>

<!-- MAIN -->
<div id="main" class="hidden">
  <div class="top">
    <b>Tamil VM Chat</b>
    <div>
      üîî <span id="unread" class="badge hidden">0</span>
      ‚öôÔ∏è <button onclick="openSettings()">‚öôÔ∏è</button>
    </div>
  </div>
  <div id="users"></div>
</div>

<!-- CHAT -->
<div id="chatPop" class="popup hidden">
<div class="card" style="width:90%;max-width:400px">
<h3 id="chatName"></h3>
<div class="chat" id="chatBox"></div>
<input id="msg" placeholder="Message">
<button onclick="sendMsg()">Send</button>
<button onclick="callUser()">üìû Audio Call</button>
<button onclick="blockUser()">üö´ Block</button>
<button onclick="closeChat()">Close</button>
</div>
</div>

<!-- INCOMING CALL -->
<div id="callPop" class="popup hidden">
<div class="card">
<h3 id="callText">Incoming Call</h3>
<div class="timer" id="callTimer"></div>
<button onclick="acceptCall()">Accept</button>
<button onclick="rejectCall()">Reject</button>
</div>
</div>

<!-- SETTINGS -->
<div id="settings" class="popup hidden">
<div class="card" style="width:300px">
<h3>Settings</h3>
<button onclick="editProfile()">Edit Profile</button>
<button onclick="logout()">Logout</button>
<button onclick="closeSettings()">Close</button>
</div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
 authDomain:"tamil-chat-2d54e.firebaseapp.com",
 databaseURL:"https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
 projectId:"tamil-chat-2d54e",
 storageBucket:"tamil-chat-2d54e.appspot.com",
 messagingSenderId:"804705969240",
 appId:"1:804705969240:web:658df281dd8360843c162d"
});

const db=firebase.database();
const storage=firebase.storage();

let me=JSON.parse(localStorage.getItem("me"));
let peer,stream,currentChat,callTimerInt;

/* AUTO LOGIN */
if(me){login.classList.add("hidden");main.classList.remove("hidden");online(true);loadUsers();}

/* LOGIN */
function login(){
 const id=Date.now();
 const file=img.files[0];
 storage.ref("profiles/"+id).put(file).then(r=>r.ref.getDownloadURL().then(url=>{
   me={id,name:name.value,age:age.value,gender:gender.value,img:url,online:true};
   db.ref("users/"+id).set(me);
   localStorage.setItem("me",JSON.stringify(me));
   location.reload();
 }));
}

/* ONLINE */
function online(v){db.ref("users/"+me.id+"/online").set(v);}
window.onbeforeunload=()=>online(false);

/* USERS */
function loadUsers(){
 db.ref("users").on("value",s=>{
  users.innerHTML="";
  s.forEach(u=>{
   if(u.key==me.id)return;
   let d=u.val();
   users.innerHTML+=`
   <div class="user" onclick="openChat(${u.key},'${d.name}')">
    <img src="${d.img}">
    ${d.name}, ${d.age}
    <div class="dot ${d.online?'on':'off'}"></div>
   </div>`;
  });
 });
}

/* CHAT */
function openChat(id,name){
 currentChat=id;
 chatName.innerText=name;
 chatBox.innerHTML="";
 chatPop.classList.remove("hidden");
 db.ref("chat/"+me.id+"_"+id).on("child_added",s=>{
  let m=s.val();
  chatBox.innerHTML+=`<div class="msg ${m.from==me.id?'me':''}">${m.text}</div>`;
 });
}
function sendMsg(){
 let t=msg.value; msg.value="";
 let m={from:me.id,text:t,time:Date.now()};
 db.ref("chat/"+me.id+"_"+currentChat).push(m);
 db.ref("chat/"+currentChat+"_"+me.id).push(m);
}

/* AUDIO CALL */
function callUser(){
 db.ref("calls/"+currentChat).set({from:me.id,status:"ring"});
}
db.ref("calls/"+me?.id).on("value",s=>{
 if(!s.exists())return;
 callPop.classList.remove("hidden");
});

function acceptCall(){
 callPop.classList.add("hidden");
 startCall();
}
function rejectCall(){
 callPop.classList.add("hidden");
 db.ref("calls/"+me.id).remove();
}
function startCall(){
 navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
  stream=s;
  startTimer();
 });
}
function startTimer(){
 let sec=0;
 callTimerInt=setInterval(()=>{
  sec++;
  callTimer.innerText="Call Time: "+sec+"s";
 },1000);
}

/* BLOCK */
function blockUser(){
 db.ref("blocked/"+me.id+"/"+currentChat).set(true);
 alert("Blocked");
}

/* SETTINGS */
function openSettings(){settings.classList.remove("hidden");}
function closeSettings(){settings.classList.add("hidden");}
function editProfile(){alert("Profile edit UI can be expanded")}
function logout(){
 online(false);
 localStorage.clear();
 location.reload();
}
function closeChat(){chatPop.classList.add("hidden");}
</script>

</body>
</html>
