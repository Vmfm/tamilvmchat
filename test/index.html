<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Private Chat + Voice Call</title>

<style>
body{margin:0;background:#111b21;color:#fff;font-family:Arial}
#loginWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0008}
#loginCard{background:#0b141a;padding:20px;border-radius:12px;width:300px;text-align:center}
#loginCard input{width:100%;padding:8px;margin:6px 0}
#loginCard img{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:6px}
#app{display:none;height:100vh;flex-direction:column}
#topBar{background:#0b141a;padding:10px;display:flex;align-items:center}
#users{flex:1;overflow:auto;background:#071215;padding:10px}
.user{display:flex;align-items:center;padding:8px;border-bottom:1px solid #222;cursor:pointer}
.user img{width:40px;height:40px;border-radius:50%;margin-right:10px}
#chat{flex:1;display:none;flex-direction:column}
#messages{flex:1;overflow:auto;padding:10px}
.msg{margin:6px 0}
.self{text-align:right}
#inputBar{display:flex;padding:8px;background:#202c33}
#inputBar input{flex:1;padding:8px;border-radius:20px;border:0}
button{background:#25d366;border:0;border-radius:20px;padding:8px 12px;color:#000;margin-left:6px}
#settings{position:absolute;right:10px;top:50px;background:#0b141a;padding:10px;border-radius:8px;display:none}
#editProfile{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008}
#editProfile .card{background:#0b141a;padding:20px;border-radius:12px}
#callUI{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000c}
</style>
</head>

<body>

<div id="loginWrap">
  <div id="loginCard">
    <img id="loginImg" src="">
    <input type="file" accept="image/*" onchange="loadLoginImg(event)">
    <input id="nameInput" placeholder="Your name">
    <button onclick="login()">Enter</button>
  </div>
</div>

<div id="app">
  <div id="topBar">
    <b id="myName"></b>
    <div style="flex:1"></div>
    <button onclick="settings.style.display=settings.style.display?'':'block'">‚öôÔ∏è</button>
    <div id="settings">
      <button onclick="openEdit()">Edit Profile</button><br><br>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="users"></div>

  <div id="chat">
    <div id="messages"></div>
    <div id="inputBar">
      <input id="msgInput">
      <button onclick="sendMsg()">Send</button>
      <button onclick="startCall()">üìû</button>
    </div>
  </div>
</div>

<div id="editProfile">
  <div class="card">
    <h3>Edit Profile</h3>
    <img id="editImg" width="80"><br>
    <input type="file" accept="image/*" onchange="loadEditImg(event)">
    <input id="editName">
    <button onclick="saveProfile()">Save</button>
    <button onclick="editProfile.style.display='none'">Close</button>
  </div>
</div>

<div id="callUI">
  <div class="card">
    <h2>Voice Call</h2>
    <button onclick="endCall()">End Call</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
 authDomain:"tamil-chat-2d54e.firebaseapp.com",
 databaseURL:"https://tamil-chat-2d54e-default-rtdb.firebaseio.com"
});
const db=firebase.database();

let me="",myImg="",peer="",pc,localStream;

function loadLoginImg(e){
 let r=new FileReader();
 r.onload=()=>loginImg.src=myImg=r.result;
 r.readAsDataURL(e.target.files[0]);
}

function login(){
 me=nameInput.value.trim();
 if(!me||!myImg)return;
 db.ref("profiles/"+me).set({name:me,img:myImg});
 loginWrap.style.display="none";
 app.style.display="flex";
 myName.textContent=me;
 loadUsers();
}

function loadUsers(){
 db.ref("profiles").on("value",s=>{
  users.innerHTML="";
  s.forEach(u=>{
   if(u.key===me)return;
   let d=document.createElement("div");
   d.className="user";
   d.innerHTML=`<img src="${u.val().img}"><div>${u.key}</div>`;
   d.onclick=()=>openChat(u.key);
   users.appendChild(d);
  })
 })
}

function openChat(u){
 peer=u;
 chat.style.display="flex";
 messages.innerHTML="";
 db.ref("pm/"+me+"/"+peer).on("child_added",s=>{
  let m=s.val();
  let d=document.createElement("div");
  d.className="msg"+(m.from===me?" self":"");
  d.textContent=m.text;
  messages.appendChild(d);
 })
}

function sendMsg(){
 let t=msgInput.value.trim();if(!t)return;
 let m={from:me,text:t};
 db.ref("pm/"+me+"/"+peer).push(m);
 db.ref("pm/"+peer+"/"+me).push(m);
 msgInput.value="";
}

/* -------- REAL VOICE CALL -------- */

async function startCall(){
 callUI.style.display="flex";
 pc=new RTCPeerConnection();
 localStream=await navigator.mediaDevices.getUserMedia({audio:true});
 localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

 pc.ontrack=e=>{
  let a=document.createElement("audio");
  a.srcObject=e.streams[0];a.autoplay=true;
 }

 pc.onicecandidate=e=>{
  if(e.candidate)db.ref("calls/"+peer+"/ice").push(e.candidate);
 }

 let offer=await pc.createOffer();
 await pc.setLocalDescription(offer);
 db.ref("calls/"+peer+"/offer").set({from:me,offer});
}

db.ref("calls/"+me+"/offer").on("value",async s=>{
 if(!s.exists())return;
 callUI.style.display="flex";
 pc=new RTCPeerConnection();
 localStream=await navigator.mediaDevices.getUserMedia({audio:true});
 localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

 pc.ontrack=e=>{
  let a=document.createElement("audio");
  a.srcObject=e.streams[0];a.autoplay=true;
 }

 pc.onicecandidate=e=>{
  if(e.candidate)db.ref("calls/"+s.val().from+"/ice").push(e.candidate);
 }

 await pc.setRemoteDescription(s.val().offer);
 let ans=await pc.createAnswer();
 await pc.setLocalDescription(ans);
 db.ref("calls/"+s.val().from+"/answer").set(ans);
});

db.ref("calls/"+me+"/answer").on("value",s=>{
 if(s.exists())pc.setRemoteDescription(s.val());
});

db.ref("calls/"+me+"/ice").on("child_added",s=>{
 pc.addIceCandidate(s.val());
});

function endCall(){
 callUI.style.display="none";
 pc.close();
 db.ref("calls/"+me).remove();
}

/* -------- PROFILE EDIT -------- */

function openEdit(){
 editProfile.style.display="flex";
 editImg.src=myImg;
 editName.value=me;
}

function loadEditImg(e){
 let r=new FileReader();
 r.onload=()=>editImg.src=r.result;
 r.readAsDataURL(e.target.files[0]);
}

function saveProfile(){
 me=editName.value.trim();
 myImg=editImg.src;
 db.ref("profiles/"+me).set({name:me,img:myImg});
 editProfile.style.display="none";
}

/* -------- LOGOUT -------- */
function logout(){
 location.reload();
}
</script>
</body>
</html>
