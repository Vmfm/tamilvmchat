<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WhatsApp Full Chat - Voice & Fixes</title>
<style>
  :root{--bg:#111b21;--panel:#202c33;--accent:#25d366;--muted:#97a4ab}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e9edef;font-family:Arial,system-ui;min-height:100vh;display:flex;flex-direction:column}
  #app{max-width:1100px;margin:0 auto;width:100%;height:100vh;display:flex;flex-direction:column;position:relative;transition:transform .28s ease}
  #topBar{padding:8px 12px;background:#0b141a;display:flex;align-items:center;gap:12px;z-index:5}
  #title{font-weight:600;display:flex;align-items:center;gap:10px}
  #notifWrap{display:flex;align-items:center;gap:8px}
  .bell{position:relative;cursor:pointer;width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,.04)}
  .badge{position:absolute;top:-6px;right:-6px;min-width:20px;height:20px;border-radius:12px;background:#ff3b30;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;padding:0 2px;box-shadow:0 2px 6px rgba(0,0,0,.6); z-index:10;}
  #panel{position:fixed;right:0;top:0;height:100vh;width:360px;background:#081214;border-left:1px solid rgba(255,255,255,.03);transform:translateX(100%);transition:transform .28s ease;z-index:100;box-shadow:-20px 0 60px rgba(0,0,0,.6);display:flex;flex-direction:column}
  #panel.open{transform:translateX(0)}
  .panelHeader{padding:14px 12px;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:8px}
  .panelTitle{font-weight:700}
  .panelClose{margin-left:auto;background:none;border:0;color:var(--accent);cursor:pointer;font-size:18px}
  .panelList{padding:8px;overflow:auto;flex:1}
  .panelItem{padding:12px;border-radius:8px;display:flex;align-items:center;gap:10px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05)}
  .panelItem:hover{background:rgba(255,255,255,.05)}
  .panelItem .who{flex:1; font-weight: bold;}
  #messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#071215}
  .msg-row{display:flex;align-items:flex-end;max-width:80%;position:relative}
  .msg-row.self{align-self:flex-end;flex-direction:row-reverse}
  .avatar{width:36px;height:36px;border-radius:50%;background:#333;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 8px;cursor:pointer;overflow:hidden}
  .bubble{background:var(--panel);padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.3;word-break:break-word}
  .msg-row.self .bubble{background:#005c4b}
  .time{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}
  #inputBar{display:flex;padding:10px;background:var(--panel);align-items:center;gap:8px}
  #messageInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff;outline:none}
  #sendBtn{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;cursor:pointer}
  #settingsPanel{position:absolute;right:12px;top:48px;background:#0b141a;border:1px solid rgba(255,255,255,.1);padding:10px;border-radius:8px;display:none;z-index:100;min-width:200px}
  .settingRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px; border-bottom:1px solid #1e2930}
  #privatePopup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:1000}
  .card{background:#0b141a;padding:15px;border-radius:12px;width:90%;max-width:500px;height:80vh;display:flex;flex-direction:column}
  #privateMessages{flex:1;overflow:auto;background:#071215;padding:10px;border-radius:8px;margin:10px 0}
  #callOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,10,20,0.9);z-index:10000;flex-direction:column}
  .callCard{background:#111b21;padding:40px;border-radius:20px;text-align:center;color:white}
  .callBtns{display:flex;gap:20px;margin-top:30px}
  .btnAccept{background:#25d366;padding:15px 30px;border-radius:30px;border:0;font-weight:bold;cursor:pointer}
  .btnDecline{background:#ff3b30;padding:15px 30px;border-radius:30px;border:0;color:white;font-weight:bold;cursor:pointer}
  #toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:10px 20px;border-radius:20px;display:none;z-index:11000}
</style>
</head>
<body>

<div id="panel">
  <div class="panelHeader">
    <div class="panelTitle">Chats</div>
    <button id="panelClose" class="panelClose">‚úï</button>
  </div>
  <div class="panelList" id="panelList"></div>
</div>

<div id="app">
  <div id="topBar">
    <div id="title">WhatsApp AI</div>
    <div style="flex:1"></div>
    <div id="notifWrap">
      <div class="bell" id="bellBtn">üîî<div class="badge" id="bellBadge" style="display:none">0</div></div>
      <button id="settingsBtn" style="background:none;border:0;font-size:20px;cursor:pointer">‚öôÔ∏è</button>
      <div id="settingsPanel">
        <div class="settingRow"><span>Audio Call</span><input type="checkbox" checked></div>
        <div class="settingRow"><span>Notifications</span><input type="checkbox" checked></div>
      </div>
    </div>
  </div>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message..."/>
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<div id="privatePopup">
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <button id="closePrivate" style="background:none;border:0;color:var(--accent);cursor:pointer">‚¨Ö Back</button>
      <div id="privateTitle" style="font-weight:bold">Name</div>
      <button id="callBtn" style="background:none;border:0;font-size:20px;cursor:pointer">üìû</button>
    </div>
    <div id="privateMessages"></div>
    <div style="display:flex;gap:10px">
      <input id="privateInput" style="flex:1;padding:10px;border-radius:20px;background:#2a3942;border:0;color:white" placeholder="Private message"/>
      <button id="privateSend" style="background:var(--accent);border:0;width:40px;height:40px;border-radius:50%;cursor:pointer">‚û§</button>
    </div>
  </div>
</div>

<div id="callOverlay">
  <div class="callCard">
    <h2 id="callFrom">Caller Name</h2>
    <p>Incoming Voice Call...</p>
    <div class="callBtns">
      <button class="btnDecline" id="declineCallBtn">Decline</button>
      <button class="btnAccept" id="acceptCallBtn">Accept</button>
    </div>
  </div>
</div>

<audio id="remoteAudio" autoplay></audio>
<div id="toast"></div>

<div id="loginWrap" style="position:fixed;inset:0;background:#111b21;display:flex;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#202c33;padding:30px;border-radius:15px;text-align:center">
    <h3>Welcome</h3>
    <input id="nameInput" placeholder="Enter name" style="padding:10px;border-radius:5px;border:0"/><br><br>
    <button id="joinBtn" style="padding:10px 40px;background:var(--accent);border:0;border-radius:5px;cursor:pointer">Join Chat</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let username = localStorage.getItem('guestName') || '';
let privateChatWith = null;
let peerConn = null;
let localStream = null;
let activeCallId = null;

const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

// --- UI Logic ---
const showToast = (m) => { const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); };

document.getElementById('settingsBtn').onclick = (e) => {
  e.stopPropagation();
  const p = document.getElementById('settingsPanel');
  p.style.display = p.style.display === 'block' ? 'none' : 'block';
};
window.onclick = () => { document.getElementById('settingsPanel').style.display = 'none'; };

document.getElementById('bellBtn').onclick = () => document.getElementById('panel').classList.add('open');
document.getElementById('panelClose').onclick = () => document.getElementById('panel').classList.remove('open');
document.getElementById('closePrivate').onclick = () => { document.getElementById('privatePopup').style.display='none'; privateChatWith = null; };

// --- Join ---
document.getElementById('joinBtn').onclick = () => {
  const n = document.getElementById('nameInput').value.trim();
  if(n) { username = n; localStorage.setItem('guestName', n); initApp(); }
};
if(username) initApp();

function initApp() {
  document.getElementById('loginWrap').style.display = 'none';
  db.ref(`status/${username}`).set(true);
  db.ref(`status/${username}`).onDisconnect().remove();

  // Listen Group
  db.ref('messages').limitToLast(50).on('child_added', s => renderMsg(s.val(), document.getElementById('messages'), true));
  
  // Listen Notifications & Panel
  db.ref(`unread/${username}`).on('value', snap => {
    const data = snap.val() || {};
    const total = Object.values(data).reduce((a,b) => a+b, 0);
    const badge = document.getElementById('bellBadge');
    badge.textContent = total;
    badge.style.display = total > 0 ? 'flex' : 'none';
    
    // Update Panel List
    const list = document.getElementById('panelList');
    list.innerHTML = '';
    Object.keys(data).forEach(other => {
      const item = document.createElement('div');
      item.className = 'panelItem';
      item.innerHTML = `<div class="who">${other}</div><div style="background:#ff3b30;padding:2px 8px;border-radius:10px;font-size:12px">${data[other]}</div>`;
      item.onclick = () => { document.getElementById('panel').classList.remove('open'); openPrivate(other); };
      list.appendChild(item);
    });
  });

  // Listen Calls
  db.ref(`calls/${username}`).on('value', snap => {
    const call = snap.val();
    if(call && call.status === 'ringing') {
      activeCallId = call.id;
      document.getElementById('callFrom').textContent = call.from;
      document.getElementById('callOverlay').style.display = 'flex';
    } else if (!call) {
      closeCallUI();
    }
  });
}

function renderMsg(data, container, isGroup) {
  if(!data) return;
  const isSelf = data.sender === username;
  const row = document.createElement('div');
  row.className = `msg-row ${isSelf?'self':''}`;
  row.innerHTML = `<div class="avatar" onclick="openPrivate('${data.sender}')">${data.sender[0]}</div>
    <div class="bubble">
      <div style="font-size:10px;color:var(--accent)">${data.sender}</div>
      ${data.text}
      <div class="time">${new Date(data.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
    </div>`;
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}

document.getElementById('sendBtn').onclick = () => {
  const t = document.getElementById('messageInput').value;
  if(!t) return;
  db.ref('messages').push({ sender: username, text: t, time: Date.now() });
  document.getElementById('messageInput').value = '';
};

// --- Private Chat ---
function openPrivate(other) {
  if(other === username) return;
  privateChatWith = other;
  document.getElementById('privateTitle').textContent = other;
  document.getElementById('privateMessages').innerHTML = '';
  document.getElementById('privatePopup').style.display = 'flex';
  
  const cid = [username, other].sort().join('_');
  db.ref(`private/${cid}`).off();
  db.ref(`private/${cid}`).limitToLast(30).on('child_added', s => renderMsg(s.val(), document.getElementById('privateMessages'), false));
  db.ref(`unread/${username}/${other}`).set(0);
}

document.getElementById('privateSend').onclick = () => {
  const t = document.getElementById('privateInput').value;
  if(!t || !privateChatWith) return;
  const cid = [username, privateChatWith].sort().join('_');
  db.ref(`private/${cid}`).push({ sender: username, text: t, time: Date.now() });
  db.ref(`unread/${privateChatWith}/${username}`).transaction(c => (c||0)+1);
  document.getElementById('privateInput').value = '';
};

// --- WebRTC Voice Call ---
async function startCall(isCaller, other) {
  peerConn = new RTCPeerConnection(iceServers);
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  localStream.getTracks().forEach(tr => peerConn.addTrack(tr, localStream));

  peerConn.ontrack = e => { document.getElementById('remoteAudio').srcObject = e.streams[0]; };
  
  const cid = isCaller ? `call_${Date.now()}` : activeCallId;

  if(isCaller) {
    const offer = await peerConn.createOffer();
    await peerConn.setLocalDescription(offer);
    db.ref(`calls/${other}`).set({ from: username, status: 'ringing', sdp: offer, id: cid });
  }

  db.ref(`calls/${username}/answer`).on('value', async s => {
    if(s.val() && isCaller) await peerConn.setRemoteDescription(new RTCSessionDescription(s.val()));
  });

  if(!isCaller) {
    db.ref(`calls/${username}/sdp`).once('value', async s => {
      await peerConn.setRemoteDescription(new RTCSessionDescription(s.val()));
      const ans = await peerConn.createAnswer();
      await peerConn.setLocalDescription(ans);
      db.ref(`calls/${other}/answer`).set(ans);
    });
  }
}

document.getElementById('callBtn').onclick = () => {
  if(privateChatWith) {
    showToast("Calling...");
    startCall(true, privateChatWith);
  }
};

document.getElementById('acceptCallBtn').onclick = () => {
  db.ref(`calls/${username}`).update({ status: 'connected' });
  startCall(false, document.getElementById('callFrom').textContent);
};

document.getElementById('declineCallBtn').onclick = () => {
  db.ref(`calls/${username}`).remove();
  closeCallUI();
};

function closeCallUI() {
  if(localStream) localStream.getTracks().forEach(t => t.stop());
  document.getElementById('callOverlay').style.display = 'none';
  showToast("Call ended");
}

</script>
</body>
</html>
