<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamil VM Chat</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff}
.hidden{display:none}
.center{display:flex;align-items:center;justify-content:center;height:100vh}
.card{background:#1c1c1c;padding:20px;border-radius:12px;width:90%;max-width:350px}
input,select,button{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:none}
button{background:#00c853;color:#000;font-weight:bold}
.user{display:flex;align-items:center;padding:10px;border-bottom:1px solid #333;cursor:pointer}
.user img{width:50px;height:50px;border-radius:50%;margin-right:10px}
.dot{width:10px;height:10px;border-radius:50%;margin-left:auto}
.online{background:#00e676}
.offline{background:#555}
.topbar{display:flex;justify-content:space-between;padding:10px;background:#000}
.badge{background:red;border-radius:50%;padding:3px 7px;font-size:12px}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:#000c}
.popup .card{height:90%}
.chat{height:60vh;overflow-y:auto;border:1px solid #333;padding:10px}
.msg{margin:5px 0}
.me{text-align:right;color:#00e676}
.timer{color:#0f0}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="card">
    <h3>Login</h3>
    <input id="name" placeholder="Name">
    <input id="age" type="number" placeholder="Age">
    <select id="gender">
      <option>Male</option>
      <option>Female</option>
    </select>
    <input type="file" id="img">
    <button onclick="login()">Continue</button>
  </div>
</div>

<!-- MAIN -->
<div id="main" class="hidden">
  <div class="topbar">
    <div>Tamil VM Chat</div>
    <div>
      üîî <span id="unread" class="badge hidden">0</span>
      ‚öôÔ∏è <button onclick="settings()">‚öôÔ∏è</button>
    </div>
  </div>
  <div id="users"></div>
</div>

<!-- CHAT POPUP -->
<div id="chatPop" class="popup hidden">
  <div class="card">
    <h3 id="chatName"></h3>
    <div class="chat" id="chatBox"></div>
    <input id="msg" placeholder="Message">
    <button onclick="sendMsg()">Send</button>
    <button onclick="startCall()">üéß Audio Call</button>
    <button onclick="blockUser()">üö´ Block</button>
    <button onclick="closeChat()">Close</button>
    <div class="timer" id="callTimer"></div>
  </div>
</div>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
});

const db = firebase.database();
const storage = firebase.storage();

let me = JSON.parse(localStorage.getItem("me"));
let currentChat = null;
let unread = 0;

/* AUTO LOGIN */
if(me){
  document.getElementById("login").classList.add("hidden");
  document.getElementById("main").classList.remove("hidden");
  setOnline(true);
  loadUsers();
}

/* LOGIN */
function login(){
  const id = Date.now();
  const file = img.files[0];
  const ref = storage.ref("profiles/"+id);
  ref.put(file).then(()=>ref.getDownloadURL().then(url=>{
    me = {id,name:name.value,age:age.value,gender:gender.value,img:url,online:true};
    db.ref("users/"+id).set(me);
    localStorage.setItem("me",JSON.stringify(me));
    location.reload();
  }));
}

/* ONLINE STATUS */
function setOnline(v){
  db.ref("users/"+me.id+"/online").set(v);
  window.onbeforeunload=()=>setOnline(false);
}

/* LOAD USERS */
function loadUsers(){
  db.ref("users").on("value",s=>{
    users.innerHTML="";
    s.forEach(u=>{
      if(u.key==me.id)return;
      const d=u.val();
      users.innerHTML+=`
      <div class="user" onclick="openChat(${u.key},'${d.name}')">
        <img src="${d.img}">
        ${d.name}, ${d.age}
        <div class="dot ${d.online?'online':'offline'}"></div>
      </div>`;
    });
  });
}

/* CHAT */
function openChat(id,name){
  currentChat=id;
  chatName.innerText=name;
  chatBox.innerHTML="";
  chatPop.classList.remove("hidden");

  db.ref("chats/"+me.id+"_"+id).on("child_added",s=>{
    const m=s.val();
    chatBox.innerHTML+=`<div class="msg ${m.from==me.id?'me':''}">${m.text}</div>`;
  });
}

function sendMsg(){
  const text=msg.value;
  msg.value="";
  const data={from:me.id,text,time:Date.now()};
  db.ref("chats/"+me.id+"_"+currentChat).push(data);
  db.ref("chats/"+currentChat+"_"+me.id).push(data);
}

/* BLOCK */
function blockUser(){
  db.ref("blocked/"+me.id+"/"+currentChat).set(true);
  alert("Blocked");
}

/* CLOSE */
function closeChat(){
  chatPop.classList.add("hidden");
}

/* AUDIO CALL (BASIC) */
let pc,stream,timer;
function startCall(){
  navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
    stream=s;
    pc=new RTCPeerConnection();
    stream.getTracks().forEach(t=>pc.addTrack(t,stream));
    startTimer();
  });
}

function startTimer(){
  let sec=0;
  timer=setInterval(()=>{
    sec++;
    callTimer.innerText="Call Time: "+sec+"s";
  },1000);
}

/* SETTINGS */
function settings(){
  if(confirm("Logout?")){
    localStorage.clear();
    setOnline(false);
    location.reload();
  }
}
</script>

</body>
</html>
