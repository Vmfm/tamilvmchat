<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamil VM Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff}
.hidden{display:none}
.center{display:flex;align-items:center;justify-content:center;height:100vh}
.card{background:#1c1c1c;padding:20px;border-radius:12px;width:90%;max-width:350px}
input,select,button{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:none}
button{background:#00c853;color:#000;font-weight:bold}
.user{display:flex;align-items:center;padding:10px;border-bottom:1px solid #333;cursor:pointer}
.user img{width:50px;height:50px;border-radius:50%;margin-right:10px}
.dot{width:10px;height:10px;border-radius:50%;margin-left:auto}
.online{background:#00e676}
.offline{background:#555}
.topbar{display:flex;justify-content:space-between;padding:10px;background:#000}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:#000c}
.chat{height:60vh;overflow-y:auto;border:1px solid #333;padding:10px}
.msg{margin:5px 0}
.me{text-align:right;color:#00e676}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="card">
    <h3>Login</h3>
    <input id="name" placeholder="Name">
    <input id="age" type="number" placeholder="Age">
    <select id="gender">
      <option value="">Select Gender</option>
      <option>Male</option>
      <option>Female</option>
    </select>
    <input type="file" id="img" accept="image/*">
    <button onclick="login()">Continue</button>
  </div>
</div>

<!-- MAIN -->
<div id="main" class="hidden">
  <div class="topbar">
    <div>Tamil VM Chat</div>
    <button onclick="logout()">Logout</button>
  </div>
  <div id="users"></div>
</div>

<!-- CHAT -->
<div id="chatPop" class="popup hidden">
  <div class="card">
    <h3 id="chatName"></h3>
    <div class="chat" id="chatBox"></div>
    <input id="msg" placeholder="Message">
    <button onclick="sendMsg()">Send</button>
    <button onclick="closeChat()">Close</button>
  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyAlWP5D79PsX29H0hIZlfvL0YV5Us7v5I4",
  authDomain: "sample-firebase-ai-app-1f408.firebaseapp.com",
  databaseURL: "https://sample-firebase-ai-app-1f408-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sample-firebase-ai-app-1f408",
  storageBucket: "sample-firebase-ai-app-1f408.firebasestorage.app",
  messagingSenderId: "657942233322",
  appId: "1:657942233322:web:a8dd9896ca8cfccdbb5793"
});

const db = firebase.database();
const storage = firebase.storage();

let me = JSON.parse(localStorage.getItem("me"));
let currentChat = null;

/* AUTO LOGIN */
if(me){
  showMain();
  setOnline(true);
  loadUsers();
}

/* LOGIN FIXED */
function login(){
  const n = name.value.trim();
  const a = age.value.trim();
  const g = gender.value;
  const file = img.files[0];

  if(!n || !a || !g || !file){
    alert("Please fill all details");
    return;
  }

  const id = Date.now();
  const ref = storage.ref("profiles/"+id);

  ref.put(file).then(()=>{
    ref.getDownloadURL().then(url=>{
      me = {
        id: id,
        name: n,
        age: a,
        gender: g,
        img: url,
        online: true
      };
      db.ref("users/"+id).set(me);
      localStorage.setItem("me",JSON.stringify(me));
      showMain();
      setOnline(true);
      loadUsers();
    });
  }).catch(e=>{
    alert("Image upload failed");
  });
}

/* UI */
function showMain(){
  document.getElementById("login").classList.add("hidden");
  document.getElementById("main").classList.remove("hidden");
}

/* ONLINE */
function setOnline(v){
  if(!me) return;
  db.ref("users/"+me.id+"/online").set(v);
  window.onbeforeunload = ()=>db.ref("users/"+me.id+"/online").set(false);
}

/* USERS */
function loadUsers(){
  db.ref("users").on("value",snap=>{
    users.innerHTML="";
    snap.forEach(u=>{
      if(u.key == me.id) return;
      const d = u.val();
      users.innerHTML += `
      <div class="user" onclick="openChat(${u.key},'${d.name}')">
        <img src="${d.img}">
        ${d.name}, ${d.age}
        <div class="dot ${d.online?'online':'offline'}"></div>
      </div>`;
    });
  });
}

/* CHAT */
function openChat(id,name){
  currentChat = id;
  chatName.innerText = name;
  chatBox.innerHTML="";
  chatPop.classList.remove("hidden");

  db.ref("chats/"+me.id+"_"+id).off();
  db.ref("chats/"+me.id+"_"+id).on("child_added",s=>{
    const m=s.val();
    chatBox.innerHTML += `<div class="msg ${m.from==me.id?'me':''}">${m.text}</div>`;
  });
}

function sendMsg(){
  if(!msg.value) return;
  const data={from:me.id,text:msg.value,time:Date.now()};
  db.ref("chats/"+me.id+"_"+currentChat).push(data);
  db.ref("chats/"+currentChat+"_"+me.id).push(data);
  msg.value="";
}

/* CLOSE */
function closeChat(){
  chatPop.classList.add("hidden");
}

/* LOGOUT */
function logout(){
  db.ref("users/"+me.id+"/online").set(false);
  localStorage.clear();
  location.reload();
}
</script>

</body>
</html>
