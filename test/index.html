<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WhatsApp Full Chat - Voice Enabled</title>
<style>
  body { margin:0; background:#111b21; color:#fff; font-family:sans-serif; }
  :root{--bg:#111b21;--panel:#202c33;--accent:#25d366;--muted:#97a4ab}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e9edef;font-family:Arial,system-ui;min-height:100vh;display:flex;flex-direction:column}
  #app{max-width:1100px;margin:0 auto;width:100%;height:100vh;display:flex;flex-direction:column;position:relative;transition:transform .28s ease}
  #topBar{padding:8px 12px;background:#0b141a;display:flex;align-items:center;gap:12px;z-index:5}
  #title{font-weight:600;display:flex;align-items:center;gap:10px}
  #notifWrap{display:flex;align-items:center;gap:8px}
  .bell{position:relative;cursor:pointer;width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,.04)}
  .badge{position:absolute;top:-6px;right:-6px;min-width:20px;height:20px;border-radius:12px;background:#ff3b30;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;padding:0 6px;box-shadow:0 2px 6px rgba(0,0,0,.6)}
  #panel{position:fixed;right:0;top:0;height:100vh;width:360px;background:#081214;border-left:1px solid rgba(255,255,255,.03);transform:translateX(100%);transition:transform .28s ease;z-index:20;box-shadow:-20px 0 60px rgba(0,0,0,.6);display:flex;flex-direction:column}
  #panel.open{transform:translateX(0)}
  .panelHeader{padding:14px 12px;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:8px}
  .panelTitle{font-weight:700}
  .panelClose{margin-left:auto;background:none;border:0;color:var(--accent);cursor:pointer;font-size:18px}
  .panelList{padding:8px;overflow:auto;flex:1}
  .panelItem{padding:10px;border-radius:8px;display:flex;align-items:center;gap:10px;cursor:pointer}
  .panelItem:hover{background:rgba(255,255,255,.02)}
  .panelItem .who{flex:1}
  .panelItem .count{background:#ff3b30;color:#fff;border-radius:12px;padding:2px 8px;font-size:12px}
  #messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#071215}
  .msg-row{display:flex;align-items:flex-end;max-width:80%;position:relative}
  .msg-row.self{align-self:flex-end;flex-direction:row-reverse}
  .avatar{width:36px;height:36px;border-radius:50%;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 8px;position:relative;cursor:pointer;border:2px solid transparent;transition:border .18s ease-in-out;overflow:hidden}
  .avatar.online{border-color:var(--accent);box-shadow:0 0 0 0 rgba(37,211,102,.6);animation:pulse 1.5s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37,211,102,.6)}70%{box-shadow:0 0 0 6px rgba(37,211,102,0)}100%{box-shadow:0 0 0 0 rgba(37,211,102,0)}}
  .popup-menu{display:none;position:absolute;top:-44px;left:0;background:var(--panel);border-radius:8px;padding:6px;flex-direction:column;z-index:30;min-width:110px}
  .avatar:hover .popup-menu{display:flex}
  .popup-menu button{background:none;border:0;color:#fff;padding:6px 8px;text-align:left;cursor:pointer;border-radius:6px}
  .bubble{background:var(--panel);padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.3;word-break:break-word}
  .msg-row.self .bubble{background:#005c4b}
  .meta{font-size:12px;color:#53bdeb;margin-bottom:4px;display:flex;align-items:center;gap:8px}
  .time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
  #inputBar{display:flex;padding:10px;background:var(--panel);align-items:center;gap:8px}
  #messageInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff;outline:none;font-size:14px}
  #sendBtn{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
  #statusLine{padding:6px 12px;font-size:13px;color:var(--muted);background:#071215}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#2a3942;color:#fff;padding:10px 14px;border-radius:10px;z-index:999;opacity:0;transition:opacity .25s,bottom .25s}
  #toast.show{opacity:1;bottom:40px}
  #loginWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999}
  #loginCard{background:#0b141a;padding:18px;border-radius:12px;display:flex;flex-direction:column;gap:10px;min-width:300px}
  #loginCard input{padding:10px;border-radius:10px;border:0;background:#162027;color:#fff}
  #loginCard button{padding:10px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  #privatePopup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1000}
  .card{background:#0b141a;padding:12px;border-radius:12px;max-width:680px;width:96%;display:flex;flex-direction:column;max-height:92%}
  #privateHeader{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  #privateMessages{flex:1;overflow:auto;padding:8px;background:#071215;border-radius:8px;display:flex;flex-direction:column;gap:8px}
  .private-bubble{background:#162027;padding:8px 10px;border-radius:10px;max-width:80%}
  .private-row.self{align-self:flex-end}
  #privateInputBar{display:flex;gap:8px;margin-top:8px}
  #privateInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff}
  #privateSend{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
  #typingPrivate{font-size:13px;color:var(--muted);margin-left:8px}
  #settingsBtn{cursor:pointer;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--muted)}
  #settingsPanel{position:absolute;right:12px;top:48px;background:#0b141a;border:1px solid rgba(255,255,255,.03);padding:10px;border-radius:8px;display:none;z-index:30}
  .settingRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 8px}
  .toggleBtn{width:46px;height:26px;border-radius:16px;background:#2a3942;position:relative;cursor:pointer;flex-shrink:0}
  .toggleKnob{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:left .18s}
  #callOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:10000;flex-direction:column;color:#fff}
  .callCard{background:#071215;padding:32px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:14px;min-width:320px}
  .callName{font-size:20px;font-weight:700}
  .callBtns{display:flex;gap:16px}
  .btnCall{padding:12px 18px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  .btnAccept{background:var(--accent);color:#071215}
  .btnDecline{background:#ff3b30;color:#fff}
  #inCallBar{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,.6);padding:8px 12px;border-radius:20px;color:#fff;display:none;z-index:10001;align-items:center;gap:10px}
  #endCallBtn{background:#ff3b30;border:0;color:#fff;padding:8px 12px;border-radius:12px;cursor:pointer}
  @media(max-width:900px){ #panel{width:310px} #app{max-width:100%} }
</style>
</head>
<body>

<div id="panel" aria-hidden="true">
  <div class="panelHeader">
    <div class="panelTitle">Private Messages</div>
    <button id="panelClose" class="panelClose">‚úï</button>
  </div>
  <div class="panelList" id="panelList"></div>
</div>

<div id="app">
  <div id="topBar">
    <div id="title"><div id="titleText">Group Chat</div></div>
    <div style="flex:1"></div>
    <div id="notifWrap">
      <div class="bell" id="bellBtn" title="Private messages">üîî
        <div class="badge" id="bellBadge" style="display:none">0</div>
      </div>
      <div id="settingsWrap">
        <button id="settingsBtn">‚öôÔ∏è</button>
        <div id="settingsPanel" role="dialog">
          <div class="settingRow">
            <div>Audio Call</div>
            <div class="toggleBtn" id="toggleCall"><div class="toggleKnob" id="toggleCallKnob"></div></div>
          </div>
          <div class="settingRow">
            <div>Private Chat</div>
            <div class="toggleBtn" id="togglePrivate"><div class="toggleKnob" id="togglePrivateKnob"></div></div>
          </div>
          <div class="settingRow">
            <div>Profile Image</div>
            <input type="file" id="profileImgInput" accept="image/*" style="color:#fff;font-size:12px">
          </div>
        </div>
      </div>
    </div>
    <div id="onlineCount" style="color:var(--muted);font-size:13px;margin-left:12px"></div>
  </div>
  <div id="statusLine"></div>
  <div id="messages" aria-live="polite"></div>
  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message" autocomplete="off"/>
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<div id="toast"></div>

<div id="loginWrap">
  <div id="loginCard">
    <div style="font-weight:700;color:#fff">Enter your name</div>
    <input id="nameInput" placeholder="Your name" />
    <button id="joinBtn">Join</button>
  </div>
</div>

<div id="privatePopup">
  <div class="card">
    <div id="privateHeader">
      <button id="closePrivate" style="background:none;border:0;color:var(--accent);font-size:18px;cursor:pointer">‚¨Ö</button>
      <div style="font-weight:700" id="privateTitle">Private Chat</div>
      <div style="flex:1"></div>
      <button id="callBtn" style="background:none;border:0;color:var(--accent);cursor:pointer;font-weight:700">üìû</button>
      <button id="blockBtn" style="background:none;border:0;color:#ff3b30;cursor:pointer;font-weight:700">üö´</button>
    </div>
    <div id="privateMessages"></div>
    <div id="typingPrivate"></div>
    <div id="privateInputBar">
      <input id="privateInput" placeholder="Type a private message" autocomplete="off"/>
      <button id="privateSend">‚û§</button>
    </div>
  </div>
</div>

<div id="callOverlay">
  <div class="callCard">
    <div style="font-size:12px;color:var(--muted)">Voice Call</div>
    <div class="callName" id="callFrom">Caller</div>
    <div id="callTimer">Ringing...</div>
    <div class="callBtns">
      <button class="btnCall btnDecline" id="declineCallBtn">Decline</button>
      <button class="btnCall btnAccept" id="acceptCallBtn">Accept</button>
    </div>
  </div>
</div>

<div id="inCallBar">
  <div id="inCallLabel">In call with <span id="inCallWith"></span></div>
  <div id="inCallElapsed">00:00</div>
  <button id="endCallBtn">End</button>
</div>

<audio id="remoteAudio" autoplay></audio>
<audio id="ringtone" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" loop></audio>
<audio id="dingAudio" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* DOM refs */
const panelEl = document.getElementById('panel'), panelListEl = document.getElementById('panelList'), bellBtn = document.getElementById('bellBtn'), bellBadge = document.getElementById('bellBadge');
const messagesEl = document.getElementById('messages'), messageInput = document.getElementById('messageInput'), sendBtn = document.getElementById('sendBtn'), statusLine = document.getElementById('statusLine'), onlineCountEl = document.getElementById('onlineCount');
const loginWrap = document.getElementById('loginWrap'), nameInput = document.getElementById('nameInput'), joinBtn = document.getElementById('joinBtn');
const privatePopup = document.getElementById('privatePopup'), privateTitle = document.getElementById('privateTitle'), privateMessages = document.getElementById('privateMessages'), privateInput = document.getElementById('privateInput'), privateSend = document.getElementById('privateSend'), callBtn = document.getElementById('callBtn'), blockBtn = document.getElementById('blockBtn');
const callOverlay = document.getElementById('callOverlay'), callFrom = document.getElementById('callFrom'), acceptCallBtn = document.getElementById('acceptCallBtn'), declineCallBtn = document.getElementById('declineCallBtn'), ringtone = document.getElementById('ringtone'), inCallBar = document.getElementById('inCallBar'), inCallWith = document.getElementById('inCallWith'), inCallElapsed = document.getElementById('inCallElapsed'), endCallBtn = document.getElementById('endCallBtn'), remoteAudio = document.getElementById('remoteAudio');

/* State */
let username = localStorage.getItem('guestName') || '', profileImage = localStorage.getItem('profileImage') || '', blockedUsers = new Set(), currentGroupRef = null, currentPrivateRef = null, privateChatWith = null, activeCall = null, callTimerInterval = null, localStream = null, peerConn = null;
const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

/* Helpers */
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }
function formatTime(ms){ const d=new Date(ms); return `${d.getHours()%12||12}:${d.getMinutes().toString().padStart(2,'0')} ${d.getHours()>=12?'PM':'AM'}`; }
function scrollToBottomSoon(el){ setTimeout(()=> { el.scrollTop = el.scrollHeight; }, 80); }
function chatId(a,b){ return [a,b].sort().join('_'); }

/* Start Logic */
if(!username) loginWrap.style.display='flex'; else startAs(username);
joinBtn.onclick=()=>{ const n=nameInput.value.trim(); if(n) startAs(n); };

function startAs(name){
  username=name; localStorage.setItem('guestName',name); loginWrap.style.display='none';
  db.ref(`status/${username}`).set(true); db.ref(`status/${username}`).onDisconnect().remove();
  startGroupListeners(); listenTypingGroup(); listenPresence(); watchPrivateChats(); listenUnreadAndPanel(); listenBlocks(); watchCallsForMe();
}

/* Group Chat */
function startGroupListeners(){
  db.ref('messages').limitToLast(50).on('child_added', snap => renderMsg(snap.val(), snap.key, messagesEl, true));
}
function renderMsg(data, key, container, isGroup){
  if(!data || blockedUsers.has(data.name)) return;
  const isSelf = data.name===username;
  const row = document.createElement('div'); row.className='msg-row'+(isSelf?' self':'');
  row.innerHTML = `<div class="avatar" data-username="${data.name}">${data.name[0]}</div>
    <div style="display:flex;flex-direction:column"><div class="meta">${data.name}</div>
    <div class="bubble">${data.text}</div><div class="time">${formatTime(data.time)}</div></div>`;
  row.querySelector('.avatar').onclick=()=>{ if(!isSelf) openPrivatePopup(data.name); };
  container.appendChild(row); scrollToBottomSoon(container);
}
sendBtn.onclick=()=>{ 
  const text=messageInput.value.trim(); if(!text) return;
  db.ref('messages').push({ name: username, text, time: Date.now() }); messageInput.value='';
};

/* Private Chat */
function openPrivatePopup(other){
  privateChatWith = other; privateTitle.textContent = `Chat with ${other}`;
  privateMessages.innerHTML = ''; privatePopup.style.display = 'flex';
  const key = chatId(username, other);
  if(currentPrivateRef) currentPrivateRef.off();
  currentPrivateRef = db.ref(`privateChats/${key}`).limitToLast(50);
  currentPrivateRef.on('child_added', snap => renderMsg(snap.val(), snap.key, privateMessages, false));
  db.ref(`unread/${username}/${other}`).set(0);
}
privateSend.onclick=()=>{
  const text=privateInput.value.trim(); if(!text || !privateChatWith) return;
  const key = chatId(username, privateChatWith);
  db.ref(`privateChats/${key}`).push({ name: username, text, time: Date.now() });
  db.ref(`unread/${privateChatWith}/${username}`).transaction(c=>(c||0)+1);
  privateInput.value='';
};

/* --- REAL VOICE CALL LOGIC (WebRTC) --- */

async function initWebRTC(otherUser, isCaller, callId) {
  peerConn = new RTCPeerConnection(iceConfig);
  
  // 1. Get Microphone
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(track => peerConn.addTrack(track, localStream));
  } catch (err) {
    showToast("Microphone access denied");
    endCall();
    return;
  }

  // 2. Handle incoming audio
  peerConn.ontrack = (event) => {
    remoteAudio.srcObject = event.streams[0];
  };

  // 3. ICE Candidates
  peerConn.onicecandidate = (event) => {
    if (event.candidate) {
      db.ref(`calls/${callId}/candidates/${username}`).push(event.candidate.toJSON());
    }
  };

  // 4. Signaling
  if (isCaller) {
    const offer = await peerConn.createOffer();
    await peerConn.setLocalDescription(offer);
    db.ref(`calls/${callId}/sdp`).set({ type: 'offer', sdp: offer.sdp });
  }

  // Listen for Remote SDP
  db.ref(`calls/${callId}/sdp`).on('value', async (snap) => {
    const data = snap.val();
    if (!data) return;
    if (isCaller && data.type === 'answer' && !peerConn.currentRemoteDescription) {
      await peerConn.setRemoteDescription(new RTCSessionDescription(data));
    } else if (!isCaller && data.type === 'offer' && !peerConn.currentRemoteDescription) {
      await peerConn.setRemoteDescription(new RTCSessionDescription(data));
      const answer = await peerConn.createAnswer();
      await peerConn.setLocalDescription(answer);
      db.ref(`calls/${callId}/sdp`).set({ type: 'answer', sdp: answer.sdp });
    }
  });

  // Listen for Remote ICE
  db.ref(`calls/${callId}/candidates/${otherUser}`).on('child_added', (snap) => {
    const cand = new RTCIceCandidate(snap.val());
    peerConn.addIceCandidate(cand);
  });
}

function watchCallsForMe() {
  db.ref('calls').on('child_added', snap => {
    const call = snap.val();
    if (call.to === username && call.status === 'ringing') {
      activeCall = { id: snap.key, ...call };
      callFrom.textContent = call.from;
      callOverlay.style.display = 'flex';
      acceptCallBtn.style.display = 'block';
      ringtone.play();
    }
  });

  db.ref('calls').on('child_changed', snap => {
    const call = snap.val();
    if (call.status === 'answered' && (call.from === username || call.to === username)) {
      startInCallUI(call.from === username ? call.to : call.from);
    }
    if (call.status === 'ended' && activeCall && snap.key === activeCall.id) {
      endCall();
    }
  });
}

callBtn.onclick = () => {
  if (!privateChatWith) return;
  const callId = `call_${Date.now()}`;
  activeCall = { id: callId, from: username, to: privateChatWith };
  db.ref(`calls/${callId}`).set({ from: username, to: privateChatWith, status: 'ringing', time: Date.now() });
  callFrom.textContent = privateChatWith;
  callOverlay.style.display = 'flex';
  acceptCallBtn.style.display = 'none';
  ringtone.play();
  initWebRTC(privateChatWith, true, callId);
};

acceptCallBtn.onclick = () => {
  if (!activeCall) return;
  db.ref(`calls/${activeCall.id}`).update({ status: 'answered' });
  ringtone.pause();
  initWebRTC(activeCall.from, false, activeCall.id);
};

declineCallBtn.onclick = () => {
  if (activeCall) db.ref(`calls/${activeCall.id}`).update({ status: 'ended' });
  endCall();
};

endCallBtn.onclick = declineCallBtn.onclick;

function startInCallUI(other) {
  callOverlay.style.display = 'none';
  inCallBar.style.display = 'flex';
  inCallWith.textContent = other;
  ringtone.pause();
}

function endCall() {
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  if (peerConn) peerConn.close();
  callOverlay.style.display = 'none';
  inCallBar.style.display = 'none';
  ringtone.pause();
  activeCall = null;
  showToast("Call ended");
}

/* Boilerplate Listeners (Presence, UI, etc.) */
function listenPresence(){
  db.ref('status').on('value', snap => { onlineCountEl.textContent = `${Object.keys(snap.val()||{}).length} online`; });
}
function listenTypingGroup(){
  messageInput.oninput=()=>{ db.ref(`typing/group/${username}`).set(true); setTimeout(()=>db.ref(`typing/group/${username}`).remove(),1500); };
  db.ref('typing/group').on('value', s=>{ const who=Object.keys(s.val()||{}).filter(x=>x!==username); statusLine.textContent=who.length?who.join(',')+' is typing...':''; });
}
function listenUnreadAndPanel(){
  db.ref(`unread/${username}`).on('value', s=>{ 
    const count = Object.values(s.val()||{}).reduce((a,b)=>a+b,0);
    bellBadge.textContent=count; bellBadge.style.display=count?'flex':'none';
  });
}
function listenBlocks(){ db.ref(`blocks/${username}`).on('value', s=>blockedUsers=new Set(Object.keys(s.val()||{}))); }
function watchPrivateChats(){} 
document.getElementById('panelClose').onclick=()=>panelEl.classList.remove('open');
bellBtn.onclick=()=>panelEl.classList.toggle('open');
document.getElementById('closePrivate').onclick=()=>privatePopup.style.display='none';

</script>
</body>
</html>
