<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Dating App â€“ Single HTML</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f0f;color:#fff}
.hidden{display:none}
header{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#1b1b1b}
.icon{cursor:pointer;font-size:20px;margin:0 6px}
.card{max-width:420px;margin:20px auto;background:#1c1c1c;padding:15px;border-radius:14px}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none}
button{background:#ff2f6d;color:#fff;font-weight:bold;cursor:pointer}
.profile{display:flex;align-items:center;background:#222;padding:10px;border-radius:12px;margin:8px 0;cursor:pointer}
.profile img{width:60px;height:60px;border-radius:50%;object-fit:cover;margin-right:10px}
.online{width:10px;height:10px;background:lime;border-radius:50%;margin-left:auto}
#profiles{max-width:420px;margin:auto}
#chat{position:fixed;bottom:0;left:0;right:0;background:#111;border-radius:16px 16px 0 0;padding:10px}
#messages{height:180px;overflow:auto;background:#000;border-radius:8px;padding:6px}
#messages div{margin:4px 0}
.videoBox video{width:100%;border-radius:10px;background:#000}
</style>
</head>
<body>

<header id="top" class="hidden">
  <div>
    <span class="icon" onclick="openSettings()">âš™ï¸</span>
  </div>
  <div>
    <span class="icon">ğŸ”” <span id="notif">0</span></span>
    <span class="icon" onclick="logout()">ğŸšª</span>
  </div>
</header>

<!-- LOGIN -->
<div class="card" id="login">
  <h2>Login</h2>
  <input id="name" placeholder="Name">
  <input id="age" type="number" placeholder="Age">
  <select id="gender"><option>Male</option><option>Female</option></select>
  <input type="file" id="photo">
  <button onclick="loginUser()">Continue</button>
</div>

<!-- PROFILES -->
<div id="profiles" class="hidden"></div>

<!-- CHAT -->
<div id="chat" class="hidden">
  <h3 id="chatName"></h3>
  <div id="messages"></div>
  <input id="msg" placeholder="Message">
  <button onclick="sendMsg()">Send</button>
  <button onclick="startAudio()">ğŸ“ Audio Call</button>
  <button onclick="startVideo()">ğŸ¥ Video Call</button>
  <button onclick="block()">ğŸš« Block</button>
  <div class="videoBox hidden" id="videoBox">
    <video id="local" autoplay muted></video>
    <video id="remote" autoplay></video>
  </div>
</div>

<!-- SETTINGS -->
<div class="card hidden" id="settings">
  <h3>Settings</h3>
  <label><input type="checkbox" id="audioOn" checked> Audio Call</label><br>
  <label><input type="checkbox" id="videoOn" checked> Video Call</label><br>
  <input type="file" id="newPhoto">
  <button onclick="changePhoto()">Change Image</button>
  <button onclick="closeSettings()">Close</button>
</div>

<script>
// Firebase config
firebase.initializeApp({
  apiKey: "AIzaSyAlWP5D79PsX29H0hIZlfvL0YV5Us7v5I4",
  authDomain: "sample-firebase-ai-app-1f408.firebaseapp.com",
  databaseURL: "https://sample-firebase-ai-app-1f408-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sample-firebase-ai-app-1f408",
  storageBucket: "sample-firebase-ai-app-1f408.firebasestorage.app",
  messagingSenderId: "657942233322",
  appId: "1:657942233322:web:a8dd9896ca8cfccdbb5793"
});

const auth=firebase.auth();
const db=firebase.database();
const st=firebase.storage();
let me=null,peerId=null,pc=null,stream=null;

// auto login
auth.onAuthStateChanged(u=>{if(u){me=u;loadProfiles();}});

function loginUser(){
 auth.signInAnonymously().then(r=>{
  me=r.user;
  const f=photo.files[0];
  const ref=st.ref('profiles/'+me.uid);
  ref.put(f).then(()=>ref.getDownloadURL()).then(url=>{
    db.ref('users/'+me.uid).set({name:name.value,age:age.value,gender:gender.value,img:url,online:true});
    loadProfiles();
  });
 });
}

function loadProfiles(){
 login.classList.add('hidden');
 top.classList.remove('hidden');
 profiles.classList.remove('hidden');
 db.ref('users').on('value',s=>{
  profiles.innerHTML='';
  s.forEach(c=>{
   if(c.key!==me.uid){
    const u=c.val();
    const d=document.createElement('div');
    d.className='profile';
    d.innerHTML=`<img src="${u.img}"><div>${u.name}, ${u.age} (${u.gender})</div><div class="online"></div>`;
    d.onclick=()=>openChat(c.key,u.name);
    profiles.appendChild(d);
   }
  });
 });
}

function openChat(id,name){peerId=id;chatName.innerText=name;chat.classList.remove('hidden');loadChat();}

function loadChat(){
 messages.innerHTML='';
 db.ref('chat/'+me.uid+'/'+peerId).on('child_added',s=>{
  const d=document.createElement('div');d.innerText=s.val().t;messages.appendChild(d);
 });
}

function sendMsg(){
 const t=msg.value;
 db.ref('chat/'+me.uid+'/'+peerId).push({t});
 db.ref('chat/'+peerId+'/'+me.uid).push({t});
 msg.value='';
}

// WEBRTC
const ice={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};

async function startAudio(){if(!audioOn.checked)return;await startCall(false);}
async function startVideo(){if(!videoOn.checked)return;await startCall(true);}

async function startCall(video){
 videoBox.classList.remove('hidden');
 stream=await navigator.mediaDevices.getUserMedia({audio:true,video:video});
 local.srcObject=stream;
 pc=new RTCPeerConnection(ice);
 stream.getTracks().forEach(t=>pc.addTrack(t,stream));
 pc.ontrack=e=>remote.srcObject=e.streams[0];
 pc.onicecandidate=e=>{if(e.candidate)db.ref('calls/'+peerId+'/ice').push(JSON.stringify(e.candidate));};
 const offer=await pc.createOffer();
 await pc.setLocalDescription(offer);
 db.ref('calls/'+peerId+'/offer').set(JSON.stringify(offer));
 listenAnswer();
}

function listenAnswer(){
 db.ref('calls/'+me.uid+'/answer').on('value',async s=>{
  if(s.val()){await pc.setRemoteDescription(JSON.parse(s.val()));}
 });
 db.ref('calls/'+me.uid+'/ice').on('child_added',s=>pc.addIceCandidate(JSON.parse(s.val())));
}

// incoming
db.ref('calls/'+me?.uid+'/offer').on('value',async s=>{
 if(s.val()&&!pc){
  videoBox.classList.remove('hidden');
  stream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  local.srcObject=stream;
  pc=new RTCPeerConnection(ice);
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
  pc.ontrack=e=>remote.srcObject=e.streams[0];
  pc.onicecandidate=e=>{if(e.candidate)db.ref('calls/'+peerId+'/ice').push(JSON.stringify(e.candidate));};
  await pc.setRemoteDescription(JSON.parse(s.val()));
  const ans=await pc.createAnswer();
  await pc.setLocalDescription(ans);
  db.ref('calls/'+peerId+'/answer').set(JSON.stringify(ans));
 }
});

function block(){db.ref('users/'+peerId).remove();alert('Blocked');}
function openSettings(){settings.classList.remove('hidden');}
function closeSettings(){settings.classList.add('hidden');}
function changePhoto(){const f=newPhoto.files[0];const r=st.ref('profiles/'+me.uid);r.put(f).then(()=>r.getDownloadURL()).then(u=>db.ref('users/'+me.uid+'/img').set(u));}
function logout(){auth.signOut();location.reload();}
</script>
</body>
</html>
